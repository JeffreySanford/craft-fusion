# Simple Production Deployment Guide

This guide describes a minimal deployment path without helper scripts. It assumes Linux with Apache (httpd) and PM2.

## Build artifacts

```bash
# Build frontend
pnpm dlx nx build craft-web --configuration=production

# Build backends
pnpm dlx nx build craft-nest
pnpm dlx nx build craft-go
```

Artifacts:

- `dist/apps/craft-web` (static frontend)
- `dist/apps/craft-nest` (NestJS)
- `dist/apps/craft-go` (Go API)

## Deploy frontend (Apache)

```bash
# Copy build output
sudo rm -rf /var/www/jeffreysanford.us/*
sudo cp -r dist/apps/craft-web/* /var/www/jeffreysanford.us/

# Permissions (Fedora)
sudo chown -R apache:apache /var/www/jeffreysanford.us/
sudo chmod -R 755 /var/www/jeffreysanford.us/
```

If you are not on Fedora, adjust the ownership user/group (often `www-data`).

## Run backends (PM2)

```bash
pm2 start dist/apps/craft-nest/main.js --name craft-nest
pm2 start dist/apps/craft-go/main --name craft-go

pm2 save
```

## Apache baseline (SPA + API proxy)

Ensure `mod_proxy`, `mod_proxy_http`, `mod_proxy_wstunnel`, and `mod_rewrite` are enabled.

```apache
<VirtualHost *:80>
  ServerName jeffreysanford.us
  ServerAlias www.jeffreysanford.us
  DocumentRoot /var/www/jeffreysanford.us

  <Directory /var/www/jeffreysanford.us>
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  RewriteEngine On
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]
  RewriteRule ^ /index.html [L]

  ProxyPreserveHost On
  ProxyPass /api/ http://127.0.0.1:3000/
  ProxyPassReverse /api/ http://127.0.0.1:3000/

  ProxyPass /api-go/ http://127.0.0.1:4000/
  ProxyPassReverse /api-go/ http://127.0.0.1:4000/

  ProxyPass /socket.io/ http://127.0.0.1:3000/socket.io/
  ProxyPassReverse /socket.io/ http://127.0.0.1:3000/socket.io/

  # Only needed if WebsocketService (/socket) is still used
  ProxyPass /socket/ http://127.0.0.1:3000/socket/
  ProxyPassReverse /socket/ http://127.0.0.1:3000/socket/
</VirtualHost>
```

## Production config sources

- Angular: `apps/craft-web/src/environments/environment.prod.ts` (generated by `apps/craft-web/generate-env.js` from `.env`).
- NestJS: `apps/craft-nest/src/environments/environment.prod.ts` and `NODE_ENV=production` in runtime.
- Go: `apps/craft-go/main.go` uses `PORT` and other env values at runtime.

## Health checks

```bash
curl -X GET "http://jeffreysanford.us:3000/health"

curl -X GET "http://jeffreysanford.us:4000/health"
```

## Notes

- Static assets are served by Apache. The NestJS app does not serve `dist/apps/craft-web` by default.
- Replace `/var/www/jeffreysanford.us` with the actual `DocumentRoot` from your Apache vhost.
- Keep ports 3000/4000 behind Apache (bind to localhost or firewall them) so Apache remains the public entrypoint.
- Helper scripts referenced in older docs no longer exist in this repo.
- Keep deployment docs in sync with `documentation/deployment-digital-ocean.md`.
