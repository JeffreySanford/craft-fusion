<div class="dashboard-layout">

  <div class="visualization-container" cdkDropList (cdkDropListDropped)="drop($event)">

    <div class="empty-state" *ngIf="displayedCharts.length === 0">
      <mat-icon>view_quilt</mat-icon>
      <h3>No Visualizations Selected</h3>
      <p>Select visualizations from the panel above to get started</p>
    </div>

    <div
      *ngFor="let chart of displayedCharts; let i = index"
      class="visualization-item"
      [ngClass]="getTileClasses(chart, i)"
      cdkDrag
      [cdkDragDisabled]="fullExpandedTileIndex !== null"
    >
      <mat-card class="chart-card" [class.expanded]="expandedTileIndex === i">
        <mat-card-header cdkDragHandle class="custom-colored" [appTextColor]="chart.color">
          <div class="chart-title">
            <mat-icon>{{ getIconForChart(chart) }}</mat-icon>
            {{ chart.name }}
          </div>
          <button
            mat-icon-button
            class="expand-button"
            *ngIf="fullExpandedTileIndex !== i"
            (click)="openFullScreen(i, $event)"
            aria-label="Expand visualization"
          >
            <mat-icon>fullscreen</mat-icon>
          </button>
          <button mat-icon-button class="restore-button" *ngIf="fullExpandedTileIndex === i" (click)="restoreTile(i, $event)" aria-label="Restore visualization">
            <mat-icon>fullscreen_exit</mat-icon>
          </button>
          <button mat-icon-button class="remove-button" (click)="removeTile(chart, $event)" aria-label="Remove visualization">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content (click)="handleTileClick(i, $event)">

          <div class="chart-content" [ngClass]="chart.chartClass">

            <ng-container [ngSwitch]="chart.component">

              <app-line-chart *ngSwitchCase="'app-line-chart'" [data]="chart.data" [width]="tileWidth" [compact]="fullExpandedTileIndex !== i"> </app-line-chart>

              <app-bar-chart *ngSwitchCase="'app-bar-chart'" [data]="chart.data" [width]="tileWidth" [compact]="fullExpandedTileIndex !== i"> </app-bar-chart>

              <app-finance-chart *ngSwitchCase="'app-finance-chart'" [data]="chart.data" [width]="tileWidth" [compact]="fullExpandedTileIndex !== i"> </app-finance-chart>

              <app-fire-alert *ngSwitchCase="'app-fire-alert'" [width]="tileWidth" [compact]="fullExpandedTileIndex !== i"> </app-fire-alert>
            </ng-container>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div class="visualization-sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <h2>Available Visualizations</h2>
      <div class="sidebar-actions">
        <button
          mat-icon-button
          class="view-toggle"
          *ngIf="!isSidebarCollapsed"
          (click)="toggleAvailableChartsView()"
          [attr.aria-label]="availableChartsView === 'tiles' ? 'Show visualization list' : 'Show visualization tiles'"
        >
          <mat-icon>{{ availableChartsView === 'tiles' ? 'view_list' : 'view_module' }}</mat-icon>
        </button>
        <button
          mat-icon-button
          class="sidebar-toggle"
          (click)="toggleVisualizationSidebar()"
          [attr.aria-label]="isSidebarCollapsed ? 'Open visualization controls' : 'Close visualization controls'"
        >
          <mat-icon>{{ isSidebarCollapsed ? 'tune' : 'close' }}</mat-icon>
        </button>
      </div>
    </div>
    <div class="sidebar-content">
      <mat-list *ngIf="availableChartsView === 'list'">
        <mat-list-item
          *ngFor="let chart of availableCharts"
          (click)="toggleChart(chart)"
          [class.active]="isChartActive(chart)"
          [appTextColor]="isChartActive(chart) ? chart.color : 'inherit'"
        >
          <mat-icon matListItemIcon class="visualization-icon" [appTextColor]="isChartActive(chart) ? chart.color : 'inherit'">{{ getIconForChart(chart) }}</mat-icon>
          <span matListItemTitle>{{ chart.name }}</span>
          <mat-icon matListItemMeta class="selection-indicator" [class.active-icon]="isChartActive(chart)" [appTextColor]="isChartActive(chart) ? chart.color : 'inherit'">
            {{ isChartActive(chart) ? 'check_circle' : 'radio_button_unchecked' }}
          </mat-icon>
        </mat-list-item>
      </mat-list>
      <div class="tile-picker" *ngIf="availableChartsView === 'tiles'">
        <button
          type="button"
          class="tile-option"
          *ngFor="let chart of availableCharts"
          (click)="toggleChart(chart)"
          [class.active]="isChartActive(chart)"
          [style.--tile-color]="chart.color"
          [attr.aria-pressed]="isChartActive(chart)"
        >
          <mat-icon class="tile-icon">{{ getIconForChart(chart) }}</mat-icon>
          <span class="tile-title">{{ chart.name }}</span>
          <mat-icon class="tile-status">
            {{ isChartActive(chart) ? 'check_circle' : 'radio_button_unchecked' }}
          </mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="fullscreen-backdrop" *ngIf="fullExpandedTileIndex !== null" (click)="handleBackdropClick($event)"></div>
