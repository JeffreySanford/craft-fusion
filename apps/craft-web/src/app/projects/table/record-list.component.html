<ng-template #noData>
  <div class="no-data">
    <mat-progress-spinner mode="indeterminate" [diameter]="100" [style.color]="'teal'"></mat-progress-spinner>
  </div>
</ng-template>
<div class="table-container">
  <mat-card class="record-collection" [@fly-in]>
    <mat-card-content>
      <div class="report">
        <div class="report-text">
          <p [hidden]="!resolved">
            Using the backend server language,
            <span [ngClass]="{ fadeToRed: fadeToRedClass }">{{ server.language }}</span>
            , a mock record set of
            <span [ngClass]="{ fadeToRed: fadeToRedClass }">{{ totalRecords }}</span>
            records was generated in <span [ngClass]="{ fadeToRed: fadeToRedClass }">{{ generationTimeLabel }}</span> and delivered in
            <span [ngClass]="{ fadeToRed: fadeToRedClass }">{{ roundtripLabel }}</span> to the Angular frontend with a latency of
            <span [ngClass]="{ fadeToRed: fadeToRedClass }">{{ networkPerformance }}</span>
          </p>
        </div>

        <div class="button-container">
          <button mat-raised-button color="primary" class="swagger-button" (click)="onSwaggerButtonClick()">Swagger API for {{ server.language }}</button>
        </div>
      </div>

      <div class="selectors" [@fly-in]>
        <mat-form-field appearance="outline">
          <mat-label>Select dataset size</mat-label>
          <mat-select class="selector" [(value)]="totalRecords" (selectionChange)="onDatasetChange($event.value)">
            <mat-option *ngFor="let size of dataSetSizes" [value]="size">
              {{ size }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Select backend server</mat-label>
          <mat-select class="selector" [value]="server.name" (selectionChange)="onSelectedServerChange($event.value)">
            <mat-option *ngFor="let server of servers" [value]="server.name">
              {{ server.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter mat-elevation-z8">
          <mat-label>Filter</mat-label>
          <input matInput #filterInput (keyup)="applyFilter($event)" placeholder="Type to search..." [(ngModel)]="dataSource.filter" />
          <button class="clear-button" mat-icon-button matSuffix (click)="clearFilter()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Table and other elements -->
  <div class="scrollable-container" [hidden]="!resolved">
    <div class="table-wrapper">
      <div class="flex-table mat-elevation-z8" [@fly-in]>
        <!-- Header Row with responsive columns -->
        <div class="flex-header-row">
          <!-- Always shown -->
          <div class="flex-header-cell" (click)="sortData({active: 'userID', direction: sort.direction === 'asc' ? 'desc' : 'asc'})">User ID</div>
          
          <!-- Only hidden on smallest screens -->
          <div class="flex-header-cell" (click)="sortData({active: 'name', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="!showMinimalColumns">Name</div>
          
          <!-- Only shown on large screens -->
          <div class="flex-header-cell address-column" (click)="sortData({active: 'address', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="showAddressColumns">Address</div>
          
          <!-- Shown on medium and large screens -->
          <div class="flex-header-cell" (click)="sortData({active: 'city', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="showMediumColumns || showAddressColumns">City</div>
          <div class="flex-header-cell" (click)="sortData({active: 'state', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="showMediumColumns || showAddressColumns">State</div>
          <div class="flex-header-cell" (click)="sortData({active: 'zip', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="showMediumColumns || showAddressColumns">Zip</div>
          
          <!-- Only shown on largest screens -->
          <div class="flex-header-cell" (click)="sortData({active: 'phone', direction: sort.direction === 'asc' ? 'desc' : 'asc'})" *ngIf="showAddressColumns">Phone</div>
          
          <!-- Always shown -->
          <div class="flex-header-cell flex-right">Actions</div>
        </div>
        
        <!-- Data Rows with responsive columns -->
        <ng-container *ngFor="let record of dataSource.filteredData | slice:paginator.pageIndex * paginator.pageSize:(paginator.pageIndex + 1) * paginator.pageSize">
          <div class="flex-row" [class.selected]="expandedElement === record" (click)="expandRow(record)">
            <!-- Always shown -->
            <div class="flex-cell">{{ record.UID }}</div>
            
            <!-- Only hidden on smallest screens -->
            <div class="flex-cell" *ngIf="!showMinimalColumns">{{ record.firstName }}&nbsp;{{ record.lastName }}</div>
            
            <!-- Only shown on large screens -->
            <div class="flex-cell address-column" *ngIf="showAddressColumns" title="{{ record.address.street }}">{{ record.address.street }}</div>
            
            <!-- Shown on medium and large screens -->
            <div class="flex-cell" *ngIf="showMediumColumns || showAddressColumns">{{ record.address.city }}</div>
            <div class="flex-cell" *ngIf="showMediumColumns || showAddressColumns">{{ record.address.state }}</div>
            <div class="flex-cell" *ngIf="showMediumColumns || showAddressColumns">{{ record.address.zipcode }}</div>
            
            <!-- Only shown on largest screens -->
            <div class="flex-cell" *ngIf="showAddressColumns">{{ record.phone.number }}</div>
            
            <!-- Always shown -->
            <div class="flex-cell flex-right">
              <button mat-icon-button (click)="showDetailView(record); $event.stopPropagation();" title="view record">
                <mat-icon>person</mat-icon>
              </button>
            </div>
          </div>
        </ng-container>

        <!-- Create a separate container for the modal overlay with fixed positioning -->
        <div class="modal-container" *ngIf="expandedElement">
          <!-- Backdrop with pointer events to close on click -->
          <div class="expanded-backdrop" (click)="expandRow(expandedElement); $event.stopPropagation();"></div>
          
          <!-- Modal content with absolute fixed positioning -->
          <div class="expand-element-detail">
            <button class="close-overlay-btn" (click)="expandRow(expandedElement); $event.stopPropagation();">
              <mat-icon>close</mat-icon>
            </button>
            <div class="expand-element-description">
              <h2 class="expand-header">Employment Income Information</h2>
              
              <div class="income-grid">
                <div *ngFor="let company of expandedElement.salary" class="income-item">
                  <div class="company-info">
                    <span class="company-name">{{ company.companyName }}</span>
                    <span class="company-salary">{{ company.annualSalary | currency }}</span>
                  </div>
                </div>
              </div>
              
              <div class="income-summary" *ngIf="expandedElement.salary && expandedElement.salary.length > 10">
                <p><strong>Note:</strong> This user has {{ expandedElement.salary.length }} sources of income.</p>
              </div>
              
              <div class="income-total">
                <span class="total-label">Total Annual Salary:</span>
                <span class="total-amount">{{ expandedElement.salary | employmentIncome | currency }}</span>
              </div>
            </div>
          </div>
        </div>

      </div>

      <mat-paginator class="mat-elevation-z8" [length]="totalRecords" [pageSize]="5" [pageSizeOptions]="[5, 25, 100]" showFirstLastButtons (page)="onTableChange($event)">
      </mat-paginator>
    </div>
  </div>
</div>

<div *ngIf="!resolved" class="loading-container">
  <ng-container *ngTemplateOutlet="noData"></ng-container>
</div>
