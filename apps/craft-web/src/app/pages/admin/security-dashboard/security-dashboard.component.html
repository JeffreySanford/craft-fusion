<div class="security-dashboard">
  <header class="section-header">
    <div>
      <p class="eyebrow">Zero-trust posture</p>
      <h3>Security & Access</h3>
      <p class="subtitle">Session integrity, transport hardening, and access controls at a glance.</p>
    </div>
    <span class="pill secure">Shielded</span>
  </header>

  <mat-tab-group class="security-tabs" disableRipple>
    <mat-tab label="Overview">
      <div class="tab-pane">
        <div class="shield-grid">
          <article class="shield-card" [ngClass]="sessionSecurityStatus.type">
            <div class="shield-icon"><mat-icon>verified_user</mat-icon></div>
            <div class="shield-body">
              <p class="label">{{ sessionSecurityStatus.label }}</p>
              <div class="value">{{ sessionSecurityStatus.value }}</div>
              <p class="hint">{{ sessionSecurityStatus.hint }}</p>
            </div>
          </article>

          <article class="shield-card" [ngClass]="activeUsersCount.type">
            <div class="shield-icon"><mat-icon>people</mat-icon></div>
            <div class="shield-body">
              <p class="label">{{ activeUsersCount.label }}</p>
              <div class="value">{{ activeUsersCount.value }}</div>
              <p class="hint">{{ activeUsersCount.hint }}</p>
            </div>
          </article>

          <article class="shield-card" [ngClass]="tlsStatus.type">
            <div class="shield-icon"><mat-icon>https</mat-icon></div>
            <div class="shield-body">
              <p class="label">{{ tlsStatus.label }}</p>
              <div class="value">{{ tlsStatus.value }}</div>
              <p class="hint">{{ tlsStatus.hint }}</p>
            </div>
          </article>

          <article class="shield-card" [ngClass]="pendingPermissions.type">
            <div class="shield-icon"><mat-icon>gpp_maybe</mat-icon></div>
            <div class="shield-body">
              <p class="label">{{ pendingPermissions.label }}</p>
              <div class="value">{{ pendingPermissions.value }}</div>
              <p class="hint">{{ pendingPermissions.hint }}</p>
            </div>
          </article>
        </div>

        <div class="feature-panel">
          <div class="panel-head">
            <div>
              <p class="eyebrow">Controls</p>
              <h4>Hardening checklist</h4>
            </div>
          </div>
          <div class="feature-grid">
            <article class="feature-card" *ngFor="let control of hardeningControls" [ngClass]="{ 'active': control.active, 'inactive': !control.active }">
              <mat-icon>{{ control.icon }}</mat-icon>
              <div>
                <p class="label">{{ control.label }}</p>
                <p class="hint">{{ control.hint }}</p>
              </div>
              <span class="badge">{{ control.badge }}</span>
            </article>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="OSCAL Scans">
      <div class="tab-pane">
        <div class="status-message" *ngIf="oscalProfilesLoading">Loading OSCAL profiles...</div>
        <div class="status-message error" *ngIf="oscalProfilesError">{{ oscalProfilesError }}</div>
        <div class="empty-state" *ngIf="!oscalProfilesLoading && !oscalProfilesError && oscalProfiles.length === 0">
          No OSCAL profiles available.
        </div>

        <div class="oscal-grid" *ngIf="oscalProfiles.length > 0">
          <article class="oscal-card" *ngFor="let profile of oscalProfiles">
            <div class="oscal-head">
              <h4>{{ profile.name }}</h4>
              <span class="status" [ngClass]="profile.status">{{ profile.status | titlecase }}</span>
            </div>
            <div class="oscal-meta">
              <div>
                <p class="label">Last run</p>
                <p class="value">{{ profile.lastRun ? (profile.lastRun | date: 'short') : 'Not run' }}</p>
              </div>
              <div>
                <p class="label">Pass / Fail</p>
                <p class="value">{{ profile.pass }} / {{ profile.fail }}</p>
              </div>
              <div>
                <p class="label">Duration</p>
                <p class="value">{{ profile.duration }}</p>
              </div>
            </div>
            <div class="oscal-actions">
              <button mat-stroked-button color="primary" (click)="runOscalScan(profile)" [disabled]="isOscalRunning(profile)">
                <mat-icon *ngIf="isOscalRunning(profile)">sync</mat-icon>
                {{ isOscalRunning(profile) ? 'Scanning...' : 'Run scan' }}
              </button>
              <button mat-button color="accent" (click)="viewOscalReport(profile)" *ngIf="hasOscalReport(profile)">View report</button>
            </div>
          </article>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="SCA Top 10">
      <div class="tab-pane">
        <div class="status-message" *ngIf="scaItemsLoading">Loading SCA items...</div>
        <div class="status-message error" *ngIf="scaItemsError">{{ scaItemsError }}</div>
        <div class="empty-state" *ngIf="!scaItemsLoading && !scaItemsError && scaItems.length === 0">
          No SCA items available.
        </div>

        <div class="sca-grid" *ngIf="scaItems.length > 0">
          <article class="sca-item" *ngFor="let item of scaItems">
            <mat-icon class="sca-icon" [ngClass]="item.status">
              {{ item.status === 'pass' ? 'check_circle' : item.status === 'warn' ? 'error_outline' : 'schedule' }}
            </mat-icon>
            <div class="sca-body">
              <p class="label">{{ item.label }}</p>
              <span class="badge" [ngClass]="item.status">{{ item.status | titlecase }}</span>
            </div>
          </article>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="SBOMs">
      <div class="tab-pane">
        <div class="status-message" *ngIf="sbomsLoading">Loading SBOMs...</div>
        <div class="status-message error" *ngIf="sbomsError">{{ sbomsError }}</div>
        <div class="empty-state" *ngIf="!sbomsLoading && !sbomsError && sboms.length === 0">
          No SBOMs available.
        </div>

        <div class="sbom-grid" *ngIf="sboms.length > 0">
          <article class="sbom-card" *ngFor="let sbom of sboms">
            <div class="sbom-head">
              <h4>{{ sbom.name }}</h4>
              <span class="badge ready">{{ sbom.status }}</span>
            </div>
            <p class="hint">Format: {{ sbom.format }}</p>
            <p class="hint">Created: {{ sbom.created | date: 'medium' }}</p>
            <p class="hint">Delta: {{ sbom.delta }}</p>
            <p class="hint" *ngIf="sbom.components">Components: {{ sbom.components }}</p>
            <p class="hint" *ngIf="sbom.vulnerabilities !== undefined">Vulnerabilities: {{ sbom.vulnerabilities }}</p>
            <div class="sbom-actions">
              <button mat-button color="accent" (click)="compareSbom(sbom)" disabled>Compare</button>
            </div>
          </article>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Real-Time Tests">
      <div class="tab-pane">
        <div class="status-message" *ngIf="realtimeChecksLoading">Loading realtime checks...</div>
        <div class="status-message error" *ngIf="realtimeChecksError">{{ realtimeChecksError }}</div>
        <div class="empty-state" *ngIf="!realtimeChecksLoading && !realtimeChecksError && realtimeChecks.length === 0">
          No realtime checks available.
        </div>

        <div class="realtime-grid" *ngIf="realtimeChecks.length > 0">
          <article class="realtime-card" *ngFor="let check of realtimeChecks" 
                   [class.running]="isRealtimeCheckRunning(check)">
            <div>
              <p class="label">
                <mat-icon *ngIf="isRealtimeCheckRunning(check)" class="spin">sync</mat-icon>
                {{ check.name }}
              </p>
              <p class="hint">Duration: {{ check.duration }}</p>
              <p class="hint" *ngIf="check.endpoint">Endpoint: {{ check.endpoint }}</p>
            </div>
            <span class="badge" [ngClass]="check.status">{{ check.status | titlecase }}</span>
            <div class="realtime-actions">
              <button mat-stroked-button color="primary" (click)="runRealtimeCheck(check)" [disabled]="isRealtimeCheckRunning(check)">
                {{ isRealtimeCheckRunning(check) ? 'Running...' : 'Run check' }}
              </button>
              <button mat-button color="accent" (click)="viewRealtimeReport(check)" *ngIf="hasRealtimeReport(check)">View report</button>
            </div>
          </article>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Findings">
      <div class="tab-pane">
        <div class="feature-panel">
          <div class="panel-head">
            <div>
              <p class="eyebrow">Findings</p>
              <h4>Actionable security insights</h4>
            </div>
            <button mat-stroked-button color="primary" (click)="exportFindings()" [disabled]="findings.length === 0">Export findings</button>
          </div>

          <div class="status-message" *ngIf="findingsLoading">Loading findings...</div>
          <div class="status-message error" *ngIf="findingsError">{{ findingsError }}</div>
          <div class="empty-state" *ngIf="!findingsLoading && !findingsError && findings.length === 0">
            No findings yet. Run a scan to populate this view.
          </div>

          <div class="findings-grid" *ngIf="findings.length > 0">
            <article class="finding-card" *ngFor="let finding of findings">
              <div class="finding-head">
                <div>
                  <p class="label">Source</p>
                  <p class="hint">{{ finding.source || 'Unknown' }}</p>
                </div>
                <span class="badge" [ngClass]="getSeverityClass(finding.severity)">{{ finding.severity || 'Unknown' }}</span>
              </div>
              <h4>{{ finding.title || 'Untitled finding' }}</h4>
              <div class="meta-row">
                <span class="meta">Component: {{ finding.component || 'Unspecified' }}</span>
                <span class="badge" [ngClass]="getFindingStatusClass(finding.status)">{{ finding.status || 'Open' }}</span>
              </div>
              <p class="hint" *ngIf="finding.createdAt">Observed: {{ finding.createdAt | date: 'mediumDate' }}</p>
            </article>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Evidence">
      <div class="tab-pane">
        <div class="feature-panel">
          <div class="panel-head">
            <div>
              <p class="eyebrow">Evidence</p>
              <h4>Artifacts and provenance</h4>
            </div>
            <button mat-stroked-button color="primary" (click)="downloadEvidenceBundle()" [disabled]="evidence.length === 0">Download bundle</button>
          </div>

          <div class="status-message" *ngIf="evidenceLoading">Loading evidence...</div>
          <div class="status-message error" *ngIf="evidenceError">{{ evidenceError }}</div>
          <div class="empty-state" *ngIf="!evidenceLoading && !evidenceError && evidence.length === 0">
            No evidence captured yet. Trigger a scan to generate artifacts.
          </div>

          <div class="evidence-grid" *ngIf="evidence.length > 0">
            <article class="evidence-card" *ngFor="let artifact of evidence">
              <div class="evidence-head">
                <div>
                  <p class="label">{{ artifact.name || 'Evidence artifact' }}</p>
                  <p class="hint">Type: {{ artifact.type || 'Unknown' }}</p>
                </div>
                <span class="badge" [ngClass]="getEvidenceStatusClass(artifact.status)">{{ artifact.status || 'Pending' }}</span>
              </div>
              <div class="meta-row">
                <span class="meta">Created: {{ artifact.createdAt ? (artifact.createdAt | date: 'mediumDate') : 'Unknown' }}</span>
                <span class="meta" *ngIf="artifact.createdBy">By: {{ artifact.createdBy }}</span>
              </div>
              <p class="hash" *ngIf="artifact.hash">Hash: {{ artifact.hash }}</p>
            </article>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
