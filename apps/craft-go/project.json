#!/bin/bash
# ============================================================
# ğŸš€ Craft-Fusion Deployment Script for Digital Ocean
# ============================================================
# This script automates deployment of Craft-Fusion.
# It handles frontend, backend, PM2 services, and NGINX.
# ------------------------------------------------------------
# âš ï¸  REMINDER: Use '--full-clean' for a fresh deployment.
# ------------------------------------------------------------

# === ğŸš€ Setup Variables ===
TOTAL_STEPS=14
CURRENT_STEP=0
PROGRESS_BAR_LENGTH=50
FULL_CLEAN=false

# Flags
if [[ "$1" == "--full-clean" ]]; then
    FULL_CLEAN=true
fi

function step_progress() {
    ((CURRENT_STEP++))
    local percentage=$((CURRENT_STEP * 100 / TOTAL_STEPS))
    local progress=$((CURRENT_STEP * PROGRESS_BAR_LENGTH / TOTAL_STEPS))
    local remaining=$((PROGRESS_BAR_LENGTH - progress))
    echo -ne "\033[0;32m[STEP $CURRENT_STEP/$TOTAL_STEPS] [$percentage%] \033[0;37m"
    printf "%-${PROGRESS_BAR_LENGTH}s" "$(printf '#%.0s' $(seq 1 $progress))"
    printf "%-${remaining}s" ""
    echo -e " \033[0;32mâœ”\033[0m"
}

# === ğŸ“Š Step 1: Connection Metrics ===
step_progress
echo "[STEP 1] ğŸ“Š Gathering Deployment Metrics..."

if [ "$FULL_CLEAN" = true ]; then
    echo "[INFO] ğŸ“¦ Measuring NPM Connection Metrics..."
    START_TIME=$(date +%s)
    NPM_SPEED=$(npm ping --json | jq '.ping')
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    echo "[INFO] ğŸ“Š NPM Speed: ${NPM_SPEED}ms"
    echo "[INFO] âœ… NPM Connection Time: ${DURATION}s"
else
    echo "[INFO] âš™ï¸ Skipping NPM Metrics. Gathering Existing Deployment Stats..."
    echo "[INFO] ğŸ”„ Checking PM2 Services..."
    pm2 list
    echo "[INFO] ğŸ”„ Checking NGINX Status..."
    sudo systemctl status nginx --no-pager
fi

# === ğŸ§¹ Step 2: Managing Dependencies ===
step_progress
echo "[STEP 2] ğŸ§¹ Managing Dependencies..."
if [ "$FULL_CLEAN" = true ]; then
    echo "[INFO] ğŸ”„ Full Clean Mode Enabled. Clearing node_modules and Cache..."
    rm -rf node_modules package-lock.json || { echo "[ERROR] âŒ Failed to clean dependencies."; exit 1; }
    npm cache clean --force || { echo "[ERROR] âŒ Failed to clear NPM cache."; exit 1; }
fi
npm install || { echo "[ERROR] âŒ Failed to install dependencies."; exit 1; }

# === ğŸ› ï¸ Step 3: Build Backend (craft-go) ===
step_progress
echo "[STEP 3] ğŸ› ï¸ Building Backend (craft-go)..."
if npx nx run craft-go:build; then
    echo "[INFO] âœ… craft-go build succeeded."
else
    echo "[ERROR] âŒ craft-go build failed."
    echo "[DEBUG] ğŸ“„ Listing Go build directory:"
    ls -l dist/apps/craft-go
    exit 1
fi

# === ğŸ› ï¸ Step 4: Build Backend (craft-nest) ===
step_progress
echo "[STEP 4] ğŸ› ï¸ Building Backend (craft-nest)..."
if npx nx run craft-nest:build:production; then
    echo "[INFO] âœ… craft-nest build succeeded."
else
    echo "[ERROR] âŒ craft-nest build failed."
    echo "[DEBUG] ğŸ“„ Listing Nest build directory:"
    ls -l dist/apps/craft-nest
    exit 1
fi

# === ğŸ”„ Step 5: Restart Services ===
step_progress
echo "[STEP 5] ğŸ”„ Restarting Backend Services with PM2..."
pm2 restart craft-go || pm2 start dist/apps/craft-go/main --name craft-go
pm2 restart craft-nest || pm2 start dist/apps/craft-nest/main.js --name craft-nest

# === ğŸ“‚ Step 6: Deploy Frontend ===
step_progress
echo "[STEP 6] ğŸ“‚ Deploying Frontend to NGINX..."
sudo rm -rf /usr/share/nginx/html/*
sudo mv dist/apps/craft-web/browser/* /usr/share/nginx/html/
sudo chown -R nginx:nginx /usr/share/nginx/html
sudo chmod -R 755 /usr/share/nginx/html
sudo restorecon -Rv /usr/share/nginx/html
sudo systemctl restart nginx

# === ğŸ›¡ï¸ Step 7: Check Snort ===
step_progress
echo "[STEP 7] ğŸ›¡ï¸ Checking Snort Logs..."
if sudo systemctl is-active --quiet snort; then
    echo "[INFO] âœ… Snort service is active."
    sudo tail -n 10 /var/log/snort/alert || echo "[WARNING] âš ï¸ No alert logs available."
else
    echo "[ERROR] âŒ Snort service is not active."
fi

# === ğŸ¯ Step 8: Final Status ===
step_progress
echo "[STEP 8] ğŸ¯ Finalizing Deployment..."
pm2 status
sudo systemctl status nginx --no-pager

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
echo -e "\n[SUCCESS] ğŸ‰ Deployment completed successfully!"
echo "[INFO] ğŸš€ Total Time: ${DURATION}s"
echo "[INFO] âœ… Services Running:"
pm2 list
echo "[INFO] ğŸ“Š Deployment Metrics:"
echo "   ğŸ•’ Total Deployment Time: ${DURATION}s"
echo "   âš¡ NPM Speed: ${NPM_SPEED:-N/A}"
echo "   ğŸ›¡ï¸ Snort Status: $(sudo systemctl is-active snort)"
echo -e "\033[0;32mDeployment Completed: 100% âœ”\033[0m"
